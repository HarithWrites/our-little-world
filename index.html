<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Our Little World ğŸ’–</title>

<!-- LINK EXTERNAL CSS -->
<link rel="stylesheet" href="style.css">
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>ğŸ’‘ Couple Login</h3>
  <input id="codeInput" placeholder="Couple Code">
  <input id="pinInput" type="password" placeholder="PIN">
  <button id="loginBtn">Enter</button>
  <p style="text-align:center">
    <a href="#" id="goCreate">Create new couple ğŸ’–</a>
  </p>
</div>

<!-- CREATE -->
<div class="card hidden" id="createCard">
  <h3>âœ¨ Create Your Space</h3>
  <input id="newCode" placeholder="Couple Code">
  <input id="newPin" placeholder="PIN">
  <input id="names" placeholder="Names (Alex & Sam)">
  <button id="createBtn">Create & Enter</button>
  <p style="text-align:center">
    <a href="#" id="goLogin">Back to login</a>
  </p>
</div>

<!-- WHO -->
<div class="card hidden" id="whoCard">
  <h3>ğŸ’– Who are you?</h3>
  <select id="whoSelect"></select>
  <button id="whoConfirm">Continue</button>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
  <h3>ğŸ’– Our Little World</h3>
  <div class="grid">
    <button data-open="chat"><span>ğŸ’¬</span>Chat</button>
    <button data-open="goals"><span>ğŸ¯</span>Goals</button>
    <button data-open="notes"><span>ğŸ’Œ</span>Notes</button>
    <button data-open="gallery"><span>ğŸ“¸</span>Gallery</button>
  </div>
</div>

<!-- CHAT -->
<div class="card hidden" id="chat">
  <h3>ğŸ’¬ Our Chat</h3>
  <div id="chatBox"></div>
  <input id="msgInput" placeholder="Say something sweet ğŸ’•">
  <button id="sendBtn">Send</button>
  <button class="secondary" data-back>â¬… Back</button>
</div>

<!-- GOALS -->
<div class="card hidden" id="goals">
  <h3>ğŸ¯ Our Goals</h3>

  <input id="goalDesc" placeholder="Goal description">
  <input id="goalDate" type="date">
  <select id="goalStatus">
    <option>Yet to start</option>
    <option>In Progress</option>
    <option>Completed</option>
    <option>Withdrawn</option>
  </select>
  <input id="goalRemarks" placeholder="Remarks">
  <button id="addGoalBtn">Add Goal</button>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Goal</th>
        <th>Target</th>
        <th>Status</th>
        <th>Remarks</th>
        <th>By</th>
        <th>âŒ</th>
      </tr>
    </thead>
    <tbody id="goalsBody"></tbody>
  </table>

  <button class="secondary" data-back>â¬… Back</button>
</div>

<!-- NOTES -->
<div class="card hidden" id="notes">
  <h3>ğŸ’Œ Notes</h3>
  <textarea id="noteText" placeholder="Write a noteâ€¦"></textarea>
  <button id="addNoteBtn">Add Note</button>
  <div id="notesList"></div>
  <button class="secondary" data-back>â¬… Back</button>
</div>

<!-- GALLERY -->
<div class="card hidden" id="gallery">
  <h3>ğŸ“¸ Gallery</h3>
  <input id="imgUrl" placeholder="Paste image URL">
  <input id="imgCap" placeholder="Caption">
  <button id="addImgBtn">Add Image</button>
  <div class="gallery" id="galleryList"></div>
  <button class="secondary" data-back>â¬… Back</button>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const API_URL = "https://script.google.com/macros/s/AKfycbzlCGALoe-lRFsrJosPi7kc_DOE8Zg7nAJcPM_xUTn-6rdZmWAzUEvvCXXXStto95GT/exec";

const state={coupleCode:null,myName:null,allNames:[],timer:null};
const $=id=>document.getElementById(id);
const screens=["loginCard","createCard","whoCard","dashboard","chat","goals","notes","gallery"];

function show(id){
  screens.forEach(s=>$(s).classList.add("hidden"));
  $(id).classList.remove("hidden");
}
function api(p){
  return fetch(API_URL+"?"+new URLSearchParams(p)).then(r=>r.json());
}

/* LOGIN */
$("loginBtn").onclick=()=>{
  api({action:"login",code:$("codeInput").value,pin:$("pinInput").value})
  .then(r=>{
    if(!r.ok) return alert("Wrong details ğŸ’”");
    state.coupleCode=$("codeInput").value;
    state.allNames=(r.names||"").split("&").map(n=>n.trim());
    const saved=localStorage.getItem("who_"+state.coupleCode);
    if(saved && state.allNames.includes(saved)){
      state.myName=saved; show("dashboard"); startChat();
    }else{
      $("whoSelect").innerHTML=state.allNames.map(n=>`<option>${n}</option>`).join("");
      show("whoCard");
    }
  });
};

$("createBtn").onclick=()=>{
  api({action:"create",code:$("newCode").value,pin:$("newPin").value,names:$("names").value})
  .then(r=>{
    if(!r.ok) return alert(r.msg);
    $("codeInput").value=$("newCode").value;
    $("pinInput").value=$("newPin").value;
    show("loginCard");
  });
};

$("whoConfirm").onclick=()=>{
  state.myName=$("whoSelect").value;
  localStorage.setItem("who_"+state.coupleCode,state.myName);
  show("dashboard"); startChat();
};

$("goCreate").onclick=e=>(e.preventDefault(),show("createCard"));
$("goLogin").onclick=e=>(e.preventDefault(),show("loginCard"));

document.querySelectorAll("[data-open]").forEach(b=>{
  b.onclick=()=>{ 
    show(b.dataset.open);
    if(b.dataset.open==="goals") loadGoals();
    if(b.dataset.open==="notes") loadNotes();
    if(b.dataset.open==="gallery") loadGallery();
  };
});
document.querySelectorAll("[data-back]").forEach(b=>b.onclick=()=>show("dashboard"));

/* CHAT */
$("sendBtn").onclick=()=>{
  const msg=$("msgInput").value.trim();
  if(!msg) return;
  api({action:"chat",code:state.coupleCode,sender:state.myName,msg});
  $("msgInput").value="";
};
function loadChat(){
  api({action:"fetch",type:"Chat",code:state.coupleCode})
  .then(rows=>{
    $("chatBox").innerHTML=(rows||[]).map(r=>{
      const mine=r[2]===state.myName;
      return `<div class="chat-row ${mine?"me":"partner"}">
        <div class="bubble">
          <div class="sender">${r[2]}</div>${r[3]}
          <div class="time">${new Date(r[1]).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}</div>
        </div>
      </div>`;
    }).join("");
    $("chatBox").scrollTop=$("chatBox").scrollHeight;
  });
}
function startChat(){
  clearInterval(state.timer);
  loadChat();
  state.timer=setInterval(loadChat,3000);
}

/* GOALS */
$("addGoalBtn").onclick=()=>{
  api({
    action:"addGoal",
    code:state.coupleCode,
    desc:$("goalDesc").value,
    date:$("goalDate").value,
    status:$("goalStatus").value,
    remarks:$("goalRemarks").value,
    createdBy:state.myName
  }).then(loadGoals);
};
function loadGoals(){
  api({action:"fetchGoals",code:state.coupleCode})
  .then(rows=>{
    $("goalsBody").innerHTML=(rows||[]).map(r=>`
      <tr>
        <td>${r[1]}</td>
        <td>${r[2]}</td>
        <td>${r[3]}</td>
        <td class="status-${r[4].replace(/\s/g,'\\ ')}">${r[4]}</td>
        <td>${r[5]||""}</td>
        <td>${r[6]}</td>
        <td><button onclick="deleteGoal(${r[1]})">âŒ</button></td>
      </tr>
    `).join("");
  });
}
window.deleteGoal=id=>{
  api({action:"deleteGoal",code:state.coupleCode,id}).then(loadGoals);
};

/* NOTES */
$("addNoteBtn").onclick=()=>{
  api({action:"addNote",code:state.coupleCode,note:$("noteText").value,by:state.myName})
  .then(()=>{ $("noteText").value=""; loadNotes(); });
};
function loadNotes(){
  api({action:"fetchNotes",code:state.coupleCode})
  .then(rows=>{
    $("notesList").innerHTML=(rows||[]).map(r=>`
      <div class="note"><b>${r[3]}</b><br>${r[2]}</div>
    `).join("");
  });
}

/* GALLERY */
$("addImgBtn").onclick=()=>{
  const url=$("imgUrl").value.trim();
  if(!url) return alert("Please paste an image URL");
  api({
    action:"addImage",
    code:state.coupleCode,
    url,
    caption:$("imgCap").value,
    by:state.myName
  }).then(()=>{
    $("imgUrl").value=$("imgCap").value="";
    loadGallery();
  });
};
function loadGallery(){
  api({action:"fetchGallery",code:state.coupleCode})
  .then(rows=>{
    $("galleryList").innerHTML=(rows||[]).map(r=>`
      <div>
        <img 
            src="${r[2]}"
            referrerpolicy="no-referrer"
            onerror="this.outerHTML='<div style=&quot;width:100%;height:150px;display:flex;align-items:center;justify-content:center;background:#f3f3f3;color:#999;border-radius:10px;font-size:12px;&quot;>Image unavailable</div>'">
        <small>${r[3]}</small><br>
        <small>by ${r[4]}</small>
      </div>
    `).join("");
  });
}

show("loginCard");
});
</script>

</body>
</html>
