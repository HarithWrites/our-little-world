<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Our Little World ðŸ’–</title>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#fff0f6;
}
.card{
  background:#fff;
  margin:14px;
  padding:16px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
h3{margin-top:0}
button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#ff5fa2;
  color:#fff;
  font-weight:bold;
}
input,textarea{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ddd;
}
.chat-msg{
  margin:6px 0;
}
a{color:#ff5fa2;text-decoration:none}
#chatBox{
  max-height: 300px;
  overflow-y: auto;
  padding: 6px;
}

/* Chat rows */
.chat-row{
  display: flex;
  margin: 6px 0;
}

/* Me (right side) */
.chat-row.me{
  justify-content: flex-end;
}

/* Partner (left side) */
.chat-row.partner{
  justify-content: flex-start;
}

/* Chat bubble */
.bubble{
  max-width: 75%;
  padding: 10px;
  border-radius: 14px;
  font-size: 14px;
}

/* Me bubble */
.chat-row.me .bubble{
  background: #ff5fa2;
  color: #fff;
  border-bottom-right-radius: 4px;
}

/* Partner bubble */
.chat-row.partner .bubble{
  background: #f1f1f1;
  color: #333;
  border-bottom-left-radius: 4px;
}

/* Timestamp */
.time{
  font-size: 11px;
  opacity: 0.7;
  margin-top: 4px;
  text-align: right;
}

select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
  margin-bottom:10px;
}

.sender{
  font-size:12px;
  font-weight:bold;
  margin-bottom:4px;
  opacity:0.85;
}

  
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>ðŸ’‘ Couple Login</h3>
  <input id="codeInput" placeholder="Couple Code">
  <input id="pinInput" type="password" placeholder="PIN">
  <button onclick="login()">Enter</button>
  <p style="text-align:center">
    <a href="#" onclick="ui.showCreate()">Create new couple ðŸ’–</a>
  </p>
</div>

<!-- CREATE -->
<div class="card" id="createCard" style="display:none">
  <h3>âœ¨ Create Your Space</h3>
  <input id="newCode" placeholder="Choose Couple Code">
  <input id="newPin" placeholder="Choose PIN">
  <input id="names" placeholder="Names (Alex & Sam)">
  <button onclick="createCouple()">Create & Enter</button>
  <p style="text-align:center">
    <a href="#" onclick="ui.showLogin()">Back to login</a>
  </p>
</div>

  <!-- WHO ARE YOU -->
<div class="card" id="whoCard" style="display:none">
  <h3>ðŸ’– Who are you?</h3>
  <select id="whoSelect">
    <option value="">Select your name</option>
  </select>
  <button onclick="confirmWho()">Continue</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <div class="card">
    <h3>ðŸ’¬ Chat</h3>
    <div id="chatBox"></div>
    <input id="msgInput" placeholder="Say something sweet ðŸ’•">
    <button onclick="sendMessage()">Send</button>
  </div>

</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxd6J1dUe78TfMWJ5wFdNNhazqZ6PsDoSjeeU4rTa71SmgExvsyNYUGr5PSkQAQxRSI/exec";

/* =====================================================
   STATE
===================================================== */
const state = {
  coupleCode: null,
  myName: null,
  partnerName: null,
  allNames: [],
  chatTimer: null
};

/* =====================================================
   API HELPER (GET ONLY â€“ CORS SAFE)
===================================================== */
function apiGet(params){
  const qs = new URLSearchParams(params).toString();
  return fetch(API_URL + "?" + qs)
    .then(res => res.json());
}

/* =====================================================
   UI
===================================================== */
const ui = {
  showLogin(){
    loginCard.style.display = "block";
    createCard.style.display = "none";
    app.style.display = "none";
  },
  showCreate(){
    loginCard.style.display = "none";
    createCard.style.display = "block";
  },
  showApp(){
    loginCard.style.display = "none";
    createCard.style.display = "none";
    app.style.display = "block";
  },
  
 renderChat(messages) {
  if (!Array.isArray(messages)) return;

  chatBox.innerHTML = messages.map(m => {
    const sender = m[2];
    const msg    = m[3];
    const time   = formatTime(m[1]);
    const mine   = sender === state.myName;

    return `
      <div class="chat-row ${mine ? 'me' : 'partner'}">
        <div class="bubble">
          <div class="sender">${sender}</div>
          <div class="text">${msg}</div>
          <div class="time">${time}</div>
        </div>
      </div>
    `;
  }).join("");

  chatBox.scrollTop = chatBox.scrollHeight;
}


};

/* =====================================================
   AUTH
===================================================== */  
  function login() {
  apiGet({
    action: "login",
    code: codeInput.value.trim(),
    pin: pinInput.value.trim()
  }).then(res => {
    if (!res.ok) {
      alert("Wrong couple code or PIN ðŸ’”");
      return;
    }

    state.coupleCode = codeInput.value.trim();

    // ðŸ’– Split names from backend
    state.allNames = (res.names || "")
      .split("&")
      .map(n => n.trim())
      .filter(Boolean);

    // Try restore identity
    const saved = localStorage.getItem("who_" + state.coupleCode);

    if (saved && state.allNames.includes(saved)) {
      setIdentity(saved);
      ui.showApp();
      startChatPolling();
    } else {
      showWhoSelector();
    }
  });
}


function createCouple(){
  apiGet({
    action: "create",
    code: newCode.value,
    pin: newPin.value,
    names: names.value
  }).then(res => {
    if(res.ok){
      codeInput.value = newCode.value;
      pinInput.value = newPin.value;
      login();
    } else {
  alert(res.msg || "Unable to create couple space");
}
  });
}

  function showWhoSelector() {
  whoSelect.innerHTML =
    `<option value="">Select your name</option>` +
    state.allNames.map(n =>
      `<option value="${n}">${n}</option>`
    ).join("");

  loginCard.style.display = "none";
  createCard.style.display = "none";
  app.style.display = "none";
  whoCard.style.display = "block";
}

  function confirmWho() {
  const selected = whoSelect.value;
  if (!selected) {
    alert("Please select your name ðŸ’–");
    return;
  }

  setIdentity(selected);

  localStorage.setItem(
    "who_" + state.coupleCode,
    selected
  );

  whoCard.style.display = "none";
  ui.showApp();
  startChatPolling();
}

  function setIdentity(me) {
  state.myName = me;
  state.partnerName =
    state.allNames.find(n => n !== me) || "Partner";
}

/* =====================================================
   CHAT
===================================================== */
function sendMessage() {
  const msg = msgInput.value.trim();
  if (!msg) return;

  apiGet({
    action: "chat",
    code: state.coupleCode,
    sender: state.myName,
    msg: msg
  }).then(() => {
    msgInput.value = "";
  });
}

const CHAT_REFRESH_INTERVAL = 3000;

function startChatPolling() {
  // ðŸ”’ ensure only one interval exists
  if (state.chatTimer) {
    clearInterval(state.chatTimer);
    state.chatTimer = null;
  }

  // Load immediately
  loadChat();

  // Start polling
  state.chatTimer = setInterval(() => {
    // Safety guard
    if (!state.coupleCode || !state.myName) return;
    loadChat();
  }, CHAT_REFRESH_INTERVAL);
}


function loadChat(){
  apiGet({
    action: "fetch",
    type: "Chat",
    code: state.coupleCode
  }).then(ui.renderChat);
  console.log("Fetching chat at", new Date().toLocaleTimeString());
}

function formatTime(value){
  const d = new Date(value);
  return d.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}

/* =====================================================
   INIT
===================================================== */
ui.showLogin();
</script>

</body>
</html>
