<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Our Little World ğŸ’–</title>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:#fff0f6;
}

.card{
  background:#fff;
  margin:12px auto;
  padding:16px;
  border-radius:14px;
  max-width:520px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

h3{ margin-top:0; }

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#ff5fa2;
  color:#fff;
  font-weight:600;
  font-size:15px;
}

button.secondary{
  background:#eee;
  color:#333;
}

input, textarea, select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:15px;
}

a{
  color:#ff5fa2;
  text-decoration:none;
}

.hidden{
  display:none !important;
}

/* CHAT */
#chatBox{
  max-height:300px;
  overflow-y:auto;
  padding:4px;
}

.chat-row{
  display:flex;
  margin:6px 0;
}

.chat-row.me{ justify-content:flex-end; }
.chat-row.partner{ justify-content:flex-start; }

.bubble{
  max-width:75%;
  padding:10px;
  border-radius:14px;
  font-size:14px;
}

.chat-row.me .bubble{
  background:#ff5fa2;
  color:#fff;
  border-bottom-right-radius:4px;
}

.chat-row.partner .bubble{
  background:#f1f1f1;
  color:#333;
  border-bottom-left-radius:4px;
}

.sender{
  font-size:12px;
  font-weight:600;
  opacity:.85;
  margin-bottom:2px;
}

.time{
  font-size:11px;
  opacity:.7;
  text-align:right;
  margin-top:4px;
}

/* DASHBOARD */
#dashboard button{
  margin:8px 0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>ğŸ’‘ Couple Login</h3>
  <input id="codeInput" placeholder="Couple Code">
  <input id="pinInput" type="password" placeholder="PIN">
  <button id="loginBtn">Enter</button>
  <p style="text-align:center">
    <a href="#" id="goCreate">Create new couple ğŸ’–</a>
  </p>
</div>

<!-- CREATE -->
<div class="card hidden" id="createCard">
  <h3>âœ¨ Create Your Space</h3>
  <input id="newCode" placeholder="Couple Code">
  <input id="newPin" placeholder="PIN">
  <input id="names" placeholder="Names (Alex & Sam)">
  <button id="createBtn">Create & Enter</button>
  <p style="text-align:center">
    <a href="#" id="goLogin">Back to login</a>
  </p>
</div>

<!-- WHO -->
<div class="card hidden" id="whoCard">
  <h3>ğŸ’– Who are you?</h3>
  <select id="whoSelect"></select>
  <button id="whoConfirm">Continue</button>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboard">
  <h3>ğŸ’– Our Little World</h3>
  <button data-open="chat">ğŸ’¬ Our Chat</button>
  <button data-open="notes">ğŸ’Œ Our Notes</button>
  <button data-open="gallery">ğŸ“¸ Our Gallery</button>
  <button data-open="todo">âœ… Our To-Do / Goals</button>
  <button data-open="timer">â³ Our Next Meet</button>
</div>

<!-- CHAT -->
<div class="card hidden feature" id="chat">
  <h3>ğŸ’¬ Our Chat</h3>
  <div id="chatBox"></div>
  <input id="msgInput" placeholder="Say something sweet ğŸ’•">
  <button id="sendBtn">Send</button>
  <button class="secondary" data-back>â¬… Back</button>
</div>

<!-- PLACEHOLDERS -->
<div class="card hidden feature" id="notes"><h3>ğŸ’Œ Notes</h3><p>Coming soonâ€¦</p><button class="secondary" data-back>â¬… Back</button></div>
<div class="card hidden feature" id="gallery"><h3>ğŸ“¸ Gallery</h3><p>Coming soonâ€¦</p><button class="secondary" data-back>â¬… Back</button></div>
<div class="card hidden feature" id="todo"><h3>âœ… Goals</h3><p>Coming soonâ€¦</p><button class="secondary" data-back>â¬… Back</button></div>
<div class="card hidden feature" id="timer"><h3>â³ Next Meet</h3><p>Coming soonâ€¦</p><button class="secondary" data-back>â¬… Back</button></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const API_URL = "https://script.google.com/macros/s/AKfycbxd6J1dUe78TfMWJ5wFdNNhazqZ6PsDoSjeeU4rTa71SmgExvsyNYUGr5PSkQAQxRSI/exec";
const CHAT_INTERVAL = 3000;

const state = {
  coupleCode:null,
  myName:null,
  allNames:[],
  timer:null
};

const $ = id => document.getElementById(id);
const sections = ["loginCard","createCard","whoCard","dashboard","chat","notes","gallery","todo","timer"];

function show(id){
  sections.forEach(s => $(s).classList.add("hidden"));
  $(id).classList.remove("hidden");
}

function api(params){
  return fetch(API_URL + "?" + new URLSearchParams(params))
    .then(r => r.json());
}

/* LOGIN */
$("loginBtn").onclick = () => {
  api({
    action:"login",
    code:$("codeInput").value.trim(),
    pin:$("pinInput").value.trim()
  }).then(res=>{
    if(!res.ok) return alert("Wrong details ğŸ’”");

    state.coupleCode = $("codeInput").value.trim();
    state.allNames = (res.names||"").split("&").map(n=>n.trim());
    const saved = localStorage.getItem("who_"+state.coupleCode);

    if(saved && state.allNames.includes(saved)){
      state.myName = saved;
      show("dashboard");
      startChat();
    }else{
      $("whoSelect").innerHTML = state.allNames.map(n=>`<option>${n}</option>`).join("");
      show("whoCard");
    }
  });
};

$("createBtn").onclick = () => {
  api({
    action:"create",
    code:$("newCode").value,
    pin:$("newPin").value,
    names:$("names").value
  }).then(res=>{
    if(!res.ok) return alert(res.msg||"Error");
    $("codeInput").value = $("newCode").value;
    $("pinInput").value = $("newPin").value;
    show("loginCard");
  });
};

$("goCreate").onclick = e => (e.preventDefault(), show("createCard"));
$("goLogin").onclick  = e => (e.preventDefault(), show("loginCard"));

$("whoConfirm").onclick = () => {
  state.myName = $("whoSelect").value;
  localStorage.setItem("who_"+state.coupleCode, state.myName);
  show("dashboard");
  startChat();
};

/* DASHBOARD NAV */
document.querySelectorAll("[data-open]").forEach(b=>{
  b.onclick = ()=> show(b.dataset.open);
});
document.querySelectorAll("[data-back]").forEach(b=>{
  b.onclick = ()=> show("dashboard");
});

/* CHAT */
$("sendBtn").onclick = () => {
  const msg = $("msgInput").value.trim();
  if(!msg) return;
  api({ action:"chat", code:state.coupleCode, sender:state.myName, msg });
  $("msgInput").value="";
};

function loadChat(){
  api({ action:"fetch", type:"Chat", code:state.coupleCode })
  .then(rows=>{
    if(!Array.isArray(rows)) return;
    $("chatBox").innerHTML = rows.map(r=>{
      const mine = r[2]===state.myName;
      return `
      <div class="chat-row ${mine?"me":"partner"}">
        <div class="bubble">
          <div class="sender">${r[2]}</div>
          ${r[3]}
          <div class="time">${new Date(r[1]).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</div>
        </div>
      </div>`;
    }).join("");
    $("chatBox").scrollTop = $("chatBox").scrollHeight;
  });
}

function startChat(){
  clearInterval(state.timer);
  loadChat();
  state.timer = setInterval(loadChat, CHAT_INTERVAL);
}

show("loginCard");
});
</script>

</body>
</html>
