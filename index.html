<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Our Little World ðŸ’–</title>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#fff0f6;
}
.card{
  background:#fff;
  margin:14px;
  padding:16px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
h3{margin-top:0}
button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#ff5fa2;
  color:#fff;
  font-weight:bold;
}
input,textarea{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ddd;
}
.chat-msg{
  margin:6px 0;
}
a{color:#ff5fa2;text-decoration:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>ðŸ’‘ Couple Login</h3>
  <input id="codeInput" placeholder="Couple Code">
  <input id="pinInput" type="password" placeholder="PIN">
  <button onclick="login()">Enter</button>
  <p style="text-align:center">
    <a href="#" onclick="ui.showCreate()">Create new couple ðŸ’–</a>
  </p>
</div>

<!-- CREATE -->
<div class="card" id="createCard" style="display:none">
  <h3>âœ¨ Create Your Space</h3>
  <input id="newCode" placeholder="Choose Couple Code">
  <input id="newPin" placeholder="Choose PIN">
  <input id="names" placeholder="Names (Alex â¤ï¸ Sam)">
  <button onclick="createCouple()">Create & Enter</button>
  <p style="text-align:center">
    <a href="#" onclick="ui.showLogin()">Back to login</a>
  </p>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <div class="card">
    <h3>ðŸ’¬ Chat</h3>
    <div id="chatBox"></div>
    <input id="msgInput" placeholder="Say something sweet ðŸ’•">
    <button onclick="sendMessage()">Send</button>
  </div>

</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyWDLZ0lSz1CvUmyNhXJqTdsFx95O7IYjMI-PkTUlx9e1z6YzgBlQL8HWnNNf4IB0bs/exec";

/* =====================================================
   STATE
===================================================== */
const state = {
  coupleCode: null
};

/* =====================================================
   API HELPER (GET ONLY â€“ CORS SAFE)
===================================================== */
function apiGet(params){
  const qs = new URLSearchParams(params).toString();
  return fetch(API_URL + "?" + qs)
    .then(res => res.json());
}

/* =====================================================
   UI
===================================================== */
const ui = {
  showLogin(){
    loginCard.style.display = "block";
    createCard.style.display = "none";
    app.style.display = "none";
  },
  showCreate(){
    loginCard.style.display = "none";
    createCard.style.display = "block";
  },
  showApp(){
    loginCard.style.display = "none";
    createCard.style.display = "none";
    app.style.display = "block";
  },
  renderChat(messages){
  if (!Array.isArray(messages)) return;

  chatBox.innerHTML = messages.map(m => {
    const sender = m[2];
    const msg    = m[3];
    const time   = formatTime(m[1]);

    const mine = sender === "Me";

    return `
      <div class="chat-row ${mine ? 'me' : 'partner'}">
        <div class="bubble">
          <div class="text">${msg}</div>
          <div class="time">${time}</div>
        </div>
      </div>
    `;
  }).join("");

  // ðŸ”¥ AUTO-SCROLL
  chatBox.scrollTop = chatBox.scrollHeight;
}

};

/* =====================================================
   AUTH
===================================================== */
function login(){
  apiGet({
    action: "login",
    code: codeInput.value,
    pin: pinInput.value
  }).then(res => {
    if(res.ok){
      state.coupleCode = codeInput.value;
      ui.showApp();
      loadChat();
      setInterval(loadChat, 3000);
    } else {
      alert("Wrong couple code or PIN ðŸ’”");
    }
  });
}

function createCouple(){
  apiGet({
    action: "create",
    code: newCode.value,
    pin: newPin.value,
    names: names.value
  }).then(res => {
    if(res.ok){
      codeInput.value = newCode.value;
      pinInput.value = newPin.value;
      login();
    } else {
      alert(res.msg);
    }
  });
}

/* =====================================================
   CHAT
===================================================== */
function sendMessage(){
  if(!msgInput.value) return;

  apiGet({
    action: "chat",
    code: state.coupleCode,
    sender: "Me",
    msg: msgInput.value
  }).then(() => {
    msgInput.value = "";
    loadChat();
  });
}

function loadChat(){
  apiGet({
    action: "fetch",
    type: "Chat",
    code: state.coupleCode
  }).then(ui.renderChat);
}

function formatTime(value){
  const d = new Date(value);
  return d.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}

/* =====================================================
   INIT
===================================================== */
ui.showLogin();
</script>

</body>
</html>
